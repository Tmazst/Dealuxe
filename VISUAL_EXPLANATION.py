"""
Visual explanation of the multi-worker problem and solution
"""

print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   THE PROBLEM - WITHOUT REDIS                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Your VPS (Gunicorn with multiple workers):

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Worker 1   â”‚      â”‚  Worker 2   â”‚      â”‚  Worker 3   â”‚
    â”‚             â”‚      â”‚             â”‚      â”‚             â”‚
    â”‚ manager =   â”‚      â”‚ manager =   â”‚      â”‚ manager =   â”‚
    â”‚ GameManager â”‚      â”‚ GameManager â”‚      â”‚ GameManager â”‚
    â”‚             â”‚      â”‚             â”‚      â”‚             â”‚
    â”‚ games = {   â”‚      â”‚ games = {   â”‚      â”‚ games = {   â”‚
    â”‚  abc123:    â”‚      â”‚  (empty!)   â”‚      â”‚  (empty!)   â”‚
    â”‚   engine_A  â”‚      â”‚             â”‚      â”‚             â”‚
    â”‚ }           â”‚      â”‚ }           â”‚      â”‚ }           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                     â†‘                     â†‘
         â”‚                     â”‚                     â”‚
    Request 1:            Request 2:            Request 3:
    Create game           Attack with           Defend
    (game_id: abc123)     game_id: abc123       game_id: abc123
                               âŒ                    âŒ
                          Can't find game!      Can't find game!


Each worker has its own Python process with separate memory!


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   THE SOLUTION - WITH REDIS                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Worker 1   â”‚      â”‚  Worker 2   â”‚      â”‚  Worker 3   â”‚
    â”‚             â”‚      â”‚             â”‚      â”‚             â”‚
    â”‚ manager =   â”‚      â”‚ manager =   â”‚      â”‚ manager =   â”‚
    â”‚ GameManager â”‚      â”‚ GameManager â”‚      â”‚ GameManager â”‚
    â”‚ (Redis)     â”‚      â”‚ (Redis)     â”‚      â”‚ (Redis)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚                    â”‚                    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Redis Server        â”‚
                    â”‚  (Shared Memory)       â”‚
                    â”‚                        â”‚
                    â”‚  game:abc123 â†’         â”‚
                    â”‚    {engine state}      â”‚
                    â”‚                        â”‚
                    â”‚  game:def456 â†’         â”‚
                    â”‚    {engine state}      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Request 1 (Worker 1): Create game â†’ Saves to Redis âœ…
    Request 2 (Worker 2): Attack      â†’ Reads from Redis âœ…
    Request 3 (Worker 3): Defend      â†’ Reads from Redis âœ…

All workers share the same game state via Redis!


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          THE FIX IN ACTION                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Before (crashes):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User creates game in Worker 1                                  â”‚
â”‚    â†’ manager.games['abc123'] = engine (phase='ATTACK')            â”‚
â”‚                                                                    â”‚
â”‚ 2. User attacks in Worker 2                                       â”‚
â”‚    â†’ manager.games['abc123'] â† KeyError or fresh engine           â”‚
â”‚    â†’ assert self.state.phase == "ATTACK"                          â”‚
â”‚    â†’ ğŸ’¥ AssertionError! (phase might be wrong or engine missing)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

After (works):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. User creates game in Worker 1                                  â”‚
â”‚    â†’ manager.create_game() â†’ Redis.set('game:abc123', engine)     â”‚
â”‚                                                                    â”‚
â”‚ 2. User attacks in Worker 2                                       â”‚
â”‚    â†’ engine = manager.get_game('abc123') â† Redis.get()            â”‚
â”‚    â†’ engine.attack() modifies state                               â”‚
â”‚    â†’ manager.update_game('abc123', engine) â† Redis.set()          â”‚
â”‚    â†’ âœ… Success! All workers see the same state                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      WHAT TO DO NOW                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

On your VPS:

1. Install Redis:
   $ sudo apt install redis-server -y
   $ sudo systemctl start redis-server

2. Upload new files:
   - Copy game/manager_redis.py â†’ game/manager.py
   - Replace app.py with updated version
   - Replace game/engine.py with updated version

3. Install Python package:
   $ source venv/bin/activate
   $ pip install redis

4. Restart your app:
   $ sudo systemctl restart gunicorn

5. Check logs:
   $ sudo journalctl -u gunicorn -f
   
   Should see:
   [MANAGER] Connected to Redis at localhost:6379
   [MANAGER] Created game <uuid> in Redis (human_vs_ai)

6. Test:
   - Create a game
   - Make an attack
   - No more AssertionError! âœ…

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""")
